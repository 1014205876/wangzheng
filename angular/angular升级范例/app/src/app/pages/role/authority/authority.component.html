<app-breadcrumbs [breadcrumbs]="['角色权限','权限管理']"></app-breadcrumbs>
<nz-card class="card" [nzTitle]="'权限列表'" [nzExtra]="extraTemplate">
  <nz-table #nzTable class="tree-table" [nzSize]="'small'" [nzData]="dataRows" [nzShowPagination]="false" [nzLoading]="loading"
    [nzLoadingDelay]="loadingDelay" [nzBordered]="true" [nzPageSize]="dataRows.length">
    <thead>
      <tr>
        <th>权限名称</th>
        <th>权限类型</th>
        <th>所属应用</th>
        <th>菜单url</th>
        <th>资源名称</th>
        <th>层级深度</th>
        <th>排序</th>
        <th>更新时间</th>
        <th>状态</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <ng-template ngFor let-data [ngForOf]="nzTable.data">
        <ng-template ngFor let-item [ngForOf]="expandDataCache[data.code]">
          <tr *ngIf="(item.parent&&item.parent.expand)||!(item.parent)">
            <td [nzIndentSize]="item.level*20" [nzShowExpand]="item.children.length>0" [(nzExpand)]="item.expand"
              (nzExpandChange)="collapse(expandDataCache[data.code],item,$event)">
              {{item.name}}
            </td>
            <td>
              <span *ngIf="item.type == 1">目录</span>
              <span *ngIf="item.type == 2">菜单</span>
              <span *ngIf="item.type == 3">功能</span>
            </td>
            <td>{{item.appName}}</td>
            <td>{{item.menuUrl}}</td>
            <td>{{item.resourceName}}</td>
            <td>{{item.deep}}</td>
            <td>{{item.sort}}</td>
            <td class="td-center">{{item.updateDate}}</td>
            <td class="td-center">
              <nz-switch [ngModel]="item.status==1" (ngModelChange)="switchange(item)" ></nz-switch>
            </td>
            <td class="td-center">
              <button nz-button nzType="default" class="table-btn" (click)="modalShow('添加子权限','addChild',item)"><i
                  nz-icon nzType="plus" nzTheme="outline"></i>添加子权限</button>
              <button nz-button nzType="default" class="table-btn" (click)="modalShow('编辑部门','edit',item)"><i nz-icon nzType="edit" nzTheme="outline"></i>编辑</button>
            </td>
          </tr>
        </ng-template>
      </ng-template>
    </tbody>
  </nz-table>
</nz-card>
<ng-template #extraTemplate>
  <nz-select [(ngModel)]="appId" (ngModelChange)="search(appId)">
    <nz-option nzValue="{{item.appId}}" nzLabel="{{item.appName}}" *ngFor="let item of appLists"></nz-option>
  </nz-select>
  <button nz-button nzType="primary" class="tableBtn" (click)="modalShow('添加权限','add')"><i nz-icon nzType="plus" nzTheme="outline"></i>添加权限</button>
</ng-template>
<nz-modal [(nzVisible)]="show" *ngIf="show" [nzTitle]="modalTitle" (nzOnCancel)="modalCancel();" [nzFooter]="null">
  <form nz-form [formGroup]="addForm" class="modalForm">
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="appId">所属应用</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <nz-select formControlName="appId" [nzDisabled]="true">
          <nz-option nzValue="" nzLabel="----"></nz-option>
          <nz-option nzValue="{{item.appId}}" nzLabel="{{item.appName}}" *ngFor="let item of appLists"></nz-option>
        </nz-select>
        <nz-form-explain *ngIf="addForm.get('appId').dirty && addForm.get('appId').errors">所属应用不能为空!</nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="parentId">父级权限</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <nz-select formControlName="parentId" [nzDisabled]="modalStatus=='addChild'">
          <nz-option nzValue="" nzLabel="----" [nzCustomContent]="true">----</nz-option>
          <nz-option [nzCustomContent]="true" nzValue="{{item.id}}" nzLabel="{{item.name}}" *ngFor="let item of parentAuth">
            <i [ngStyle]="{'padding-left': item.deep>1? (item.deep-1)*15+'px': 0+'px'}">&nbsp;</i>
            <img src="../../../../../assets/images/icon/department.png" style="height: 14px;" />
            {{item.name}}
          </nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="name">权限名称</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <input nz-input formControlName="name" id="name" type="text" placeholder="请输入权限名称">
        <nz-form-explain *ngIf="addForm.get('name').dirty && addForm.get('name').errors">权限名称不能为空!</nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="sort">排序</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <input nz-input formControlName="sort" id="sort" type="text" maxlength="2"
          placeholder="请输入排序">
        <nz-form-explain *ngIf="addForm.get('sort').dirty && addForm.get('sort').errors">
          <ng-container *ngIf="addForm.get('sort').hasError('required')">
            排序不能为空，最大2个字符!
          </ng-container>
          <ng-container *ngIf="addForm.get('sort').hasError('confirm')">
            排序只能为1~99的数字!
          </ng-container>
        </nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="status">状态</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <nz-radio-group formControlName="status">
          <label nz-radio [nzValue]="1">启用</label>
          <label nz-radio [nzValue]="0">禁用</label>
        </nz-radio-group>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="type">权限类型</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <nz-radio-group formControlName="type"  (ngModelChange)="validChange(modalItems.type,2,'menuUrl')">
          <label nz-radio [nzValue]="1">目录</label>
          <label nz-radio [nzValue]="2">菜单</label>
          <label nz-radio [nzValue]="3">功能</label>
        </nz-radio-group>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item [hidden]="modalItems.type!==2">
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="menuUrl">菜单url</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <input nz-input formControlName="menuUrl" id="menuUrl" type="text"  placeholder="请输入菜单url">
        <nz-form-explain *ngIf="addForm.get('menuUrl').dirty && addForm.get('menuUrl').errors">菜单url不能为空!</nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSm]="6" [nzXs]="24" nzRequired nzFor="resourceName">资源名称</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <input nz-input formControlName="resourceName" id="resourceName" type="text" 
          placeholder="请输入资源名称">
        <nz-form-explain *ngIf="addForm.get('resourceName').dirty && addForm.get('resourceName').errors">资源名称不能为空!</nz-form-explain>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item [hidden]="modalItems.parentId">
      <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="icon">icon类名</nz-form-label>
      <nz-form-control [nzSm]="16" [nzXs]="24">
        <input nz-input formControlName="icon" id="icon" type="text"
          placeholder="请输入icon类">
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-control [nzOffset]="6" [nzSm]="18">
        <button nz-button (click)="modalCancel();resetForm($event)">取消</button>
        <button nz-button (click)="submited($event)" nzType="primary" [disabled]="!addForm.valid">确定</button>
      </nz-form-control>
    </nz-form-item>
  </form>
</nz-modal>